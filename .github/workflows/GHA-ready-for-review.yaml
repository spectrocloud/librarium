# This workflow will post to Slack when a PR is labeled with "notify-slack". 
# It will notify the appropriate reviewers based on each reviewer's local time (tz) window.
# It also ensures that Slack is not notified multiple times for the same PR.

name: Ready for Review Slack Notification

on:
  pull_request:
    types: [labeled]

jobs:
  notify:
    if: github.event.label.name == 'notify-slack'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode reviewers.json secret
        env:
          REVIEWERS_JSON_B64: ${{ secrets.REVIEWERS_JSON_B64 }}
        run: |
          echo "$REVIEWERS_JSON_B64" | base64 --decode > reviewers.json

      - name: Check if Slack was already notified
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENTS=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")

          if echo "$COMMENTS" | jq -e '.[] | select(.body | contains("Slack notified"))' > /dev/null; then
            echo "notified=true" >> $GITHUB_OUTPUT
          else
            echo "notified=false" >> $GITHUB_OUTPUT
          fi

      - name: Choose Reviewers From Config
        if: steps.check.outputs.notified == 'false'
        id: pick
        run: |
          to_minutes () {
            local t="$1"
            if [[ "$t" == *:* ]]; then
              local hh="${t%%:*}"
              local mm="${t##*:}"
              echo $((10#$hh * 60 + 10#$mm))
            else
              # Back-compat: integer hour => HH:00
              echo $((10#$t * 60))
            fi
          }

          now_in_tz () {
            local tz="$1"
            local hh mm day
            hh=$(TZ="$tz" date +%H)
            mm=$(TZ="$tz" date +%M)
            day=$(TZ="$tz" date +%a | tr '[:upper:]' '[:lower:]')
            echo "$((10#$hh * 60 + 10#$mm)) $day $hh $mm"
          }

          REVIEWERS=""

          for reviewer in $(jq -r 'keys[]' reviewers.json); do
            START_RAW=$(jq -r ".\"$reviewer\".start" reviewers.json)
            END_RAW=$(jq -r ".\"$reviewer\".end" reviewers.json)
            SLACK_ID=$(jq -r ".\"$reviewer\".slack_id" reviewers.json)
            TZID=$(jq -r ".\"$reviewer\".tz // \"UTC\"" reviewers.json)

            read -r NOW_MIN DAY HH MM <<< "$(now_in_tz "$TZID")"
            echo "Reviewer: $reviewer | TZ: $TZID | Local: ${HH}:${MM} | Day: $DAY"

            if jq -e ".\"$reviewer\".days" reviewers.json > /dev/null; then
              DAYS=$(jq -r ".\"$reviewer\".days[]" reviewers.json | tr '\n' ' ')
              [[ "$DAYS" != *"$DAY"* ]] && continue
            fi

            START_MIN=$(to_minutes "$START_RAW")
            END_MIN=$(to_minutes "$END_RAW")

            if [ "$NOW_MIN" -ge "$START_MIN" ] && [ "$NOW_MIN" -lt "$END_MIN" ]; then
              REVIEWERS+="<@$SLACK_ID> "
            fi
          done

          if [ -z "$REVIEWERS" ]; then
            REVIEWERS="<!here> _(No reviewers available â€” notifying team)_"
          fi

          echo "reviewers=$REVIEWERS" >> $GITHUB_OUTPUT

      - name: Post to Slack
        if: steps.check.outputs.notified == 'false'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REVIEWERS: ${{ steps.pick.outputs.reviewers }}
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          TITLE="${{ github.event.pull_request.title }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"

          payload=$(jq -n \
            --arg text "*Ready for review:* <$PR_URL|$TITLE>\n*Author:* $AUTHOR\n*Reviewers:* $REVIEWERS" \
            '{text: $text}')

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK"

      - name: Leave a comment to prevent duplicate notifications
        if: steps.check.outputs.notified == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"body":"Slack notified"}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
