---
title: "Deploy Edge Native Cluster"
metaTitle: "Deploy Edge Native Cluster using VirtualBox and VMWare vSphere"
metaDescription: "Learn how to use the Edge installer ISO image generated by CanvOS to build Edge devices and deploy a cluster on those Edge devices."
icon: ""
category: ["tutorial"]
hideToC: false
fullWidth: false
---

import Tabs from 'shared/components/ui/Tabs';
import WarningBox from 'shared/components/WarningBox';
import InfoBox from 'shared/components/InfoBox';

# Deploy Edge Native K3s Cluster
Deploying an edge native Kubernetes cluster requires all edge hosts to be provisioned already with Kairos based immutable operating system. In cases where multiple edge hosts require the same configuration, it is challenging for the IT/Site/Operations team to ensure scale consistency in terms of OS and other configurations, such as networking, proxy, security certificates, tooling, partitioning, and user privileges. 

Here are primary use cases for setting up VMs as edge hosts and deploying the edge native K3s cluster on those VMs: 

- IT administrators to prepare and test the desired edge installer ISO image for a consistent deployment at scale.

- Site operators to provision edge hosts and identify the additional user-data to install on a set of edge hosts.

- Infrastructure team to prepare a cluster profile using the provider OS image and deploy cloud native clusters.


As an example, imagine you are an IT administrator for a retail company that has decided to expand to 1000 new stores this year. Your job is to deploy single-node Kubernetes clusters at the edge for each new store. Assuming all edge hosts have the same configuration, you must prepare an edge installer image and provision edge hosts so that the infrastructure team can prepare a cluster profile and deploy a Kubernetes cluster on all those edge hosts.


In this tutorial, you will generate edge installer artifacts using Kairos-based immutable OS, create a VM template, and provision VMs. You will then use the VMs as edge hosts to test the installer image's ease of use for consistent deployments and deploy the edge native K3s cluster.   

# Prerequisites
To complete this tutorial, you will need the following items:
<br/>

* A physical or virtual machine as a *Development Environment*  to generate edge installation artifacts. The machine should have **x86** or **x86_64** (also know as **amd64**) processor architecture.

* Minimum hardware configuration - 4 CPU, 8 GB memory, and 100 GB storage.

* Either one of Ubuntu 20.04, Ubuntu 22.04, or openSUSE Leap 15.4 operating system (OS). 

* [Git CLI](https://cli.github.com/manual/installation) 2.30.x or later. 

* [Docker Engine](https://docs.docker.com/engine/install/) 20.10.x or later. Ensure that you can create [privileged containers](https://docs.docker.com/engine/reference/commandline/run/#privileged) on your machine.


* A [Spectro Cloud](https://console.spectrocloud.com) account. If you have not signed up, you can sign up for a [free trial](https://www.spectrocloud.com/free-tier/).


* Tenant admin access to Palette to generate a new registration token for Edge hosts.

* VMWare vCenter server URL, login credentials, and names of the data center, data store, resource pool, folder, cluster, and network.




# Clone GitHub Repository

Clone the [CanvOS](https://github.com/spectrocloud/CanvOS.git) repository containing the starter code for generating edge native image artifacts. 
<br />

```bash
git clone https://github.com/spectrocloud/CanvOS.git
```
CanvOS repository follows [EdgeForge workflow](clusters/edge/edgeforge-workflow) and leverages [Earthly](https://earthly.dev/) and Kairos to build all artifacts. 


Clone the [Tutorials](https://github.com/spectrocloud/tutorials.git) repository containing the starter code for building a VM template and scripts to provision/delete VMs. 
<br />

```bash
git clone https://github.com/spectrocloud/tutorials.git
```


# Build Edge Native Image Artifacts

Refer to the [Build Edge Native Image Artifacts](edge/palette-canvos) guide for generating an edge installer ISO image and provider OS images. Here are the summarized steps. 

Change into the **CanvOS** directory.
<br />

```bash
cd CanvOS
```
Checkout the **v3.3.3** tag.
<br />

```bash
git checkout v3.3.3
```
Next, open the **.arg** file in any editor of your choice, and edit the value for `CUSTOM_TAG` variable. You can enter your initials as the value. Ensure that it is made up of all lower case alphanumeric characters. Agent will use this variable as a suffix in the provider image tags. The current example uses the following value:

<br />

```bash
CUSTOM_TAG=demo
```

Next, use the following command to create a **user-data** file containing the login credentials for edge hosts and a token to allow edge hosts to register themselves with Palette automatically. You will have to log in to [Palette](https://console.spectrocloud.com), and navigate to **Tenant Settings** > **Registration Tokens** > **Add New Registration Token** to create a new token. 


Before you issue the following command, ensure to edit the `edgeHostToken` parameter value with the registration token copied from Palette. 
<br />

```bash
cat <<'EOF' > user-data
#cloud-config
stylus:
  site:
    edgeHostToken: aUAxxxxxxxxx0ChYCrO
install:
  poweroff: true
users:
  - name: kairos
    passwd: kairos
EOF
```
Lastly, issue the following command to build the artifacts. 
<br />

```bash
./earthly.sh +build-all-images --PE_VERSION=$(git describe --abbrev=0 --tags)
```

```bash coloredLines=2-2|#006622
# Output condensed for readability
===================== Earthly Build SUCCESS ===================== 
Share your logs with an Earthly account (experimental)! Register for one at https://ci.earthly.dev.
```
This command will take up to 15-20 minutes to finish.
<br />

List the edge installer ISO image and checksum by issuing the following command from the **CanvOS** directory.
<br />

```bash
ls build/
```

Export the path to the ISO file in an environment variable to use later in the tutorial to mount this directory to a Docker container. 
<br />

```bash
export ISOFILEPATH=$PWD/build
echo $ISOFILEPATH
```

List the Docker images to show two provider OS images, one compatible with lightweight Kubernetes (K3s) v1.24.6 and another with K3s v1.25.2.
<br />

```bash
docker images
```

If you want to use these provider images in your cluster profile, you can push them to the *ttl.sh* or any other image registry, and refer those images in the **OS layer** of your cluster profile.


After generating edge installation artifacts, the next step is to provision a VM as an Edge host to test the edge installer ISO image. You can provision a VM in VMWare vSphere or VirtualBox.


# Set Up Test Environment
Change into the **tutorials** directory.
<br />

```bash
cd tutorials
```

Build the Docker image locally in the development environment. This Docker environment has the necessary tools, [GOVC](https://github.com/vmware/govmomi/tree/main/govc#govc) and [Packer](https://www.packer.io/), installed.
<br />

```bash
docker build --build-arg PALETTE_VERSION=3.3.0 --build-arg PALETTE_CLI_VERSION=3.3.0 -t tutorials .
```

Next, mount the directory containing your ISO file while provisioning a container from the `tutorials` Docker image you created above. Recall that the path to the directory containing your ISO file is stored in the `ISOFILEPATH` environment variable. 

Issue the following command to ensure the `ISOFILEPATH` has the correct path. 
<br />

```bash
echo $ISOFILEPATH
```

<InfoBox>

The environment variable set using `export [var-name]=[var-value]` will not persist across terminal sessions. In other words, if you have changed or opened a new terminal session in your development environment, you will lose the `ISOFILEPATH` variable and have to set it again. 

</InfoBox>

This command will create a container from the `tutorials` Docker image, and open a bash session into it.
<br />

```bash
docker run --name tutorialContainer --interactive --tty --volume "${ISOFILEPATH}:/edge-native/vmware/packer/build" tutorials
```
The command above will keep STDIN open, bind mount the directory containing your ISO file to the **/edge-native/vmware/packer/build** in the container, and 
allocate a pseudo-TTY to open a bash session into the tutorials container. 


In the  tutorials container bash session, change into the Packer directory.
<br />

```bash
cd edge-native/vmware/packer/
```

Rename or copy the **vsphere.hcl.template** to **vsphere.hcl**.
<br />

```bash
mv vsphere.hcl.template vsphere.hcl
```

Modify the **vsphere.hcl** file to meet your environment needs. Edit only the following custom variables to define the vCenter details. 
<br />

```bash
vi vsphere.hcl
```

```bash
# Custom Variables
vcenter_server   = ""
vcenter_username = ""
vcenter_password = ""
vcenter_datacenter      = ""
vcenter_datastore       = ""
vcenter_resource_pool   = ""
vcenter_folder          = ""
vcenter_cluster         = ""
vcenter_network         = ""
```

After saving your vCenter details in the **vsphere.hcl** file, use the following command to create a VM template using Packer.
<br />

```bash
packer build --var-file=vsphere.hcl build.pkr.hcl
```

The build process can take 7-10 minutes to finish depending on your machine's and network configuration.

```bash coloredLines=10-11|#006622
# Sample output
==> vsphere-iso.edge-template: Power on VM...
    vsphere-iso.edge-template: Please shutdown virtual machine within 10m0s.
==> vsphere-iso.edge-template: Deleting Floppy drives...
==> vsphere-iso.edge-template: Eject CD-ROM drives...
==> vsphere-iso.edge-template: Deleting CD-ROM drives...
==> vsphere-iso.edge-template: Convert VM into template...
Build 'vsphere-iso.edge-template' finished after 7 minutes 13 seconds.
==> Wait completed after 7 minutes 13 seconds
==> Builds finished. The artifacts of successful builds are:
--> vsphere-iso.edge-template: palette-edge-template
```

### Clone the VM Template

Now that we have the template built we can create our actual edge host images.  To do this, we will clone the template.

These next steps will use the `GOVC` tool built into the Docker image.  You will need to add your environment information to the `setenv.sh` file to proceed.

< br />

1. Change into the `clone_vm_template` directory

```bash
cd ../clone_vm_template/
```

2. Rename the `setenv.sh.template`

```bash
mv setenv.sh.template setenv.sh
```

3. Modify the values for your environment.  Make sure to provide a **VM_PREFIX**.

```bash
vi setenv.sh
```

**SAMPLE**

```bash
#!/bin/bash

#GOVC Properties
#VCenter Endpoint
export GOVC_URL=                # https://vcenter.company.com
export GOVC_USERNAME=
export GOVC_PASSWORD=
export GOVC_INSECURE=1 #1 if insecure
export GOVC_DATACENTER=
export GOVC_DATASTORE=
export GOVC_NETWORK=
export GOVC_RESOURCE_POOL=
export GOVC_FOLDER=

export NO_OF_VMS=3
export VM_PREFIX=
export INSTALLER_TEMPLATE="palette-edge-template"
```

<InfoBox>

The default is to create 3 VMs, if you are limited on resources then a single node is sufficient to complete this tutorial.

</InfoBox>

Create VMs

```bash
./deploy-edge-host.sh
```

## Validate

You should see the VMs registered with Palette automatically.
![Registered](/tutorials/edge-native/registered_nodes.png)

<InfoBox>

These steps should be done on the machine used to complete the Building Edge Native Artifacts How To

</InfoBox>

Verify images exist.

```bash
docker images
```

**Sample Output**

```bash
REPOSITORY               TAG                  IMAGE ID       CREATED          SIZE
ttl.sh/ubuntu-demo       k3s-v1.24.7-v3.3.3   4ae30a34286f   19 minutes ago   2.49GB
ttl.sh/ubuntu-demo       k3s-v1.25.2-v3.3.3   87ef433aa0db   19 minutes ago   2.49GB
earthly/earthly          v0.7.4               d771cc8edc38   2 weeks ago      333MB
```

<InfoBox>
The repository target above is ephemeral and images are not designed to stay for long periods of time.  We are using this repository for demo and quick start purposes but it is not designed for a production environment.  If you wish to use your own registry, tag the docker images appropriately and push them to that registry.
</InfoBox>

2. Push each image to `ttl.sh`

```bash
docker push ttl.sh/ubuntu-demo:k3s-v1.25.2-v3.3.3
```

```bash
docker push ttl.sh/ubuntu-demo:k3s-v1.24.7-v3.3.3
```

<InfoBox>
As a reminder, ttl.sh is a short lived registry.  By default these images have a default time to live of 24 hours.  If you do not complete this tutorial within 24 hours of pushing these images they will no long exist and will need to be re-pushed.
</InfoBox>

## Register Edge Host to Palette

1. Create the Cluster Profile

* Navigate to Palette [Palette Endpoint](https://console.spectrocloud.com/)

* Login to your organization  
If you have not signed up you can sign up for a free trial [Here](https://www.spectrocloud.com/free-tier/)
* Once you are logged in navigate to the `Default` Project

![Default Project Image](/tutorials/edge-native/default_project.png)

* Select `Clusters` from the left hand side.
* Select `Edge Hosts`
* 

```bash
ssh kairos@192.168.1.159
The authenticity of host '192.168.1.159 (192.168.1.159)' can't be established.
ED25519 key fingerprint is SHA256:oSXVM/3pXbILlrVsv2N3uDFf4rsJqURhm32FWuW2wjc.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.1.159' (ED25519) to the list of known hosts.
kairos@192.168.1.159's password:
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-58-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Palette eXtended Kubernetes Edge
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

kairos@edge-f35b0bef47ff5f4c91eda32e0e28016d:~
```

## Create Palette Profile

1. Create the Cluster Profile

* Navigate to Palette [Palette Endpoint](https://console.spectrocloud.com/)

* Login to your organization  
If you have not signed up you can sign up for a free trial [Here](https://www.spectrocloud.com/free-tier/)

* Once you are logged in navigate to the `Default` Project

![Default Project Image](/tutorials/edge-native/default_project.png)

Select `Profiles` from the left hand menu

* Click `Add New Profile`
* Give the Profile a name

```yaml
system.uri: 'ttl.sh/{{ .spectro.system.clusterprofile.infra.name }}:k3s-{{ .spectro.system.clusterprofile.infra.version}}'
```

# Cleanup

# Wrap-Up