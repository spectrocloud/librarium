---
partial_category: eks-pod-identity
partial_name: eks-pod-identity-prerequisites
---

- Self-hosted Palette or Palette VerteX deployed on an Amazon EKS cluster with Kubernetes version 1.24 or later.

  - A ConfigMap named `palette-global-config` must exist in the `kube-system` namespace with a `managementClusterName` key set to the EKS management cluster's name where Palette or Palette VerteX is deployed.

    If this key is missing, the fallback mechanism will obtain the cluster's name using IMDS and EC2 tags, but for this to work, the cluster must have only [EKS managed node groups](https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html) with a CNI plugin that does not block IMDS access from pods.

    <details>

    <summary> Click to display kubectl commands to check for and create the ConfigMap </summary>

    1. Log in to the Local UI of the leader host of the Palette or Palette VerteX management cluster.

    2. On the **Cluster** page, under **Environment**, click on the **Admin Kubeconfig File** to download it to your local machine.

    3. On your local machine, open a terminal session and export the `KUBECONFIG` environment variable to point to the downloaded `kubeconfig` file.

       ```bash
       export KUBECONFIG=/path/to/downloaded/kubeconfig
       ``` 
    
    4. Use the following kubectl command to check if the `palette-global-config` ConfigMap already exists.

       ```bash
       kubectl describe configmap palette-global-config --namespace kube-system
       ```

       If the ConfigMap exists, the output will be similar to the following example.

       ```yaml hideClipboard
       apiVersion: v1
       kind: ConfigMap
       metadata:
         name: palette-global-config
         namespace: kube-system
       data:
         managementClusterName: "palette-eks-management-cluster"
       ```

    5. If the ConfigMap does not exist, use the following kubectl command to create it. Replace
       `<eks-management-cluster-name>` with the name of your EKS management cluster where Palette or Palette VerteX is deployed.

       ```bash
       kubectl create configmap palette-global-config \
         --from-literal=managementClusterName="<eks-management-cluster-name>" \
         --namespace kube-system
       ```

    </details>

  - The EKS Pod Identity Agent must be enabled on the Amazon EKS cluster. Refer to the
    [Set up the Amazon EKS Pod Identity Agent](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-agent-setup.html)
    guide for more information.

- Access to the Amazon EKS cluster's kubeconfig file. You must be able to use `kubectl` to perform validation steps on
  the cluster.

- A Palette account with [tenant admin](/tenant-settings/) access.

- Three [IAM roles](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html) must be created for
  Palette. This includes Palette itself and two of its services. The following table lists the IAM roles that must be
  created.

  | Service                  | IAM Role Name Example      |
  | ------------------------ | -------------------------- |
  | Palette                  | `SpectroCloudRole`         |
  | Palette Hubble service   | `SpectroCloudHubbleRole`   |
  | Palette identity service | `SpectroCloudIdentityRole` |

  - The following trust policy must be assigned to all of the IAM roles created for Palette and the two services. This
    trust policy is the same as outlined in the
    [Amazon EKS documentation](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-association.html#pod-id-association-create).

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowEksAuthToAssumeRoleForPodIdentity",
          "Effect": "Allow",
          "Principal": {
            "Service": "pods.eks.amazonaws.com"
          },
          "Action": ["sts:AssumeRole", "sts:TagSession"]
        }
      ]
    }
    ```

  - The [required IAM policies](/clusters/public-cloud/aws/required-iam-policies/) must be assigned to the IAM role created for Palette (for
    example, `SpectroCloudRole`).

    - In addition to the required IAM policies, the following policies must also be assigned to the IAM role created for
      Palette.

      ```json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "eks:ListPodIdentityAssociations",
              "eks:CreatePodIdentityAssociation",
              "eks:DeletePodIdentityAssociation"
            ],
            "Resource": "*"
          },
          {
            "Effect": "Allow",
            "Action": ["iam:PassRole"],
            "Resource": "*"
          }
        ]
      }
      ```

  - The following policies must be assigned to the IAM role created for the Palette Hubble service (for example,
    `SpectroCloudHubbleRole`).

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowIAMValidation",
          "Effect": "Allow",
          "Action": [
            "iam:GetRole",
            "iam:ListAttachedRolePolicies",
            "iam:ListRolePolicies",
            "iam:GetRolePolicy",
            "iam:GetPolicy",
            "iam:GetPolicyVersion"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowEC2Describe",
          "Effect": "Allow",
          "Action": [
            "ec2:DescribeRegions",
            "ec2:DescribeAvailabilityZones",
            "ec2:DescribeVpcs",
            "ec2:DescribeSubnets",
            "ec2:DescribeRouteTables",
            "ec2:DescribeKeyPairs"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowEKSDescribe",
          "Effect": "Allow",
          "Action": [
            "eks:DescribeCluster",
            "eks:ListClusters",
            "eks:DescribeNodegroup",
            "eks:ListNodegroups",
            "eks:DescribeAddon",
            "eks:ListAddons"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowKMSRead",
          "Effect": "Allow",
          "Action": [
            "kms:ListKeys",
            "kms:ListAliases",
            "kms:DescribeKey",
            "kms:GetKeyPolicy",
            "kms:GetKeyRotationStatus"
          ],
          "Resource": "*"
        }
      ]
    }
    ```

  - The following policies must be assigned to the IAM role created for the Palette identity service (for example,
    `SpectroCloudIdentityRole`).

    - Replace `<aws-account-id>` with your AWS account ID.
    - Replace `<role-name-for-palette-iam-role>` with the name of the IAM role created for Palette (for example,
      `SpectroCloudRole`).

    <br />

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "EKSPodIdentityManagement",
          "Effect": "Allow",
          "Action": [
            "eks:ListPodIdentityAssociations",
            "eks:CreatePodIdentityAssociation",
            "eks:DeletePodIdentityAssociation"
          ],
          "Resource": [
            "*"
          ]
        },
        {
          "Sid": "EC2",
          "Effect": "Allow",
          "Action": [
            "ec2:DescribeInstances"
          ],
          "Resource": [
            "*"
          ]
        },
        {
          "Sid": "IAM",
          "Effect": "Allow",
          "Action": [
            "iam:GetRole"
          ],
          "Resource": [
            "arn:aws:iam::<aws-account-id>:role/<role-name-for-palette-iam-role>"
          ]
        },
        {
          "Sid": "IAMPassRoleforPodIdentity",
          "Effect": "Allow",
          "Action": [
            "iam:PassRole"
          ],
          "Resource": [
            "arn:aws:iam::<aws-account-id>:role/<role-name-for-palette-iam-role>"
          ]
        }
      ]
    }
    ```

- The IAM roles created for the Palette Hubble service and Palette identity service must have pod identity associations
  with the following Kubernetes service accounts.

  | **Palette Service** | **Kubernetes Namespace** | **Kubernetes Service Account** |
  | ------------------- | ------------------------ | ------------------------------ |
  | Hubble              | `hubble-system`          | `spectro-hubble`               |
  | Identity service    | `palette-identity`       | `palette-identity`             |

  <details>

  <summary> Click to display example AWS CLI commands to create pod identity associations </summary>

  Use the following AWS CLI command to create a pod identity association for the Palette Hubble service. Replace
  `<eks-cluster-name>` with the name of your Amazon EKS cluster, `<aws-account-id>` with your AWS account ID, and
  `<hubble-service-iam-role>` with the name of the IAM role created for the Palette Hubble service (for example,
  `SpectroCloudHubbleRole`).

  ```bash
  aws eks create-pod-identity-association \
  --cluster-name <eks-cluster-name> \
  --namespace hubble-system \
  --service-account spectro-hubble \
  --role-arn arn:aws:iam::<aws-account-id>:role/<hubble-service-iam-role>
  ```

  Similarly, use the following AWS CLI command to create a pod identity association for the Palette identity service.
  Replace `<eks-cluster-name>` with the name of your Amazon EKS cluster, `<aws-account-id>` with your AWS account ID,
  and `<identity-service-iam-role>` with the name of the IAM role created for the Palette identity service (for example,
  `SpectroCloudIdentityRole`).

  ```bash
  aws eks create-pod-identity-association \
  --cluster-name <eks-cluster-name> \
  --namespace palette-identity \
  --service-account palette-identity \
  --role-arn arn:aws:iam::<aws-account-id>:role/<identity-service-iam-role>
  ```

  </details>

- (Optional) If you need your Kubernetes clusters to access AWS resources in different AWS accounts to the one where
  Palette is deployed, you must configure role chaining for EKS Pod Identity. For more information, refer to the
  [Access AWS Resources using EKS Pod Identity Target IAM Roles](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-assign-target-role.html)
  guide.