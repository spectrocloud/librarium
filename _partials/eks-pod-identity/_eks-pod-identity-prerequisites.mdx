---
partial_category: eks-pod-identity
partial_name: eks-pod-identity-prerequisites
---

- Self-hosted Palette or Palette VerteX deployed on an Amazon EKS cluster with Kubernetes version 1.24 or later.

  - The Palette or Palette VerteX stack must be deployed on
    [managed node groups](https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html), and not
    self-managed nodes. This is required to obtain the cluster name using Instance Metadata Service (IMDS).

  - The EKS Pod Identity Agent must be enabled on the Amazon EKS cluster. Refer to the
    [Set up the Amazon EKS Pod Identity Agent](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-agent-setup.html)
    guide for more information.

- Access to the Amazon EKS cluster's kubeconfig file. You must be able to use `kubectl` to perform validation steps on
  the cluster.

- A Palette account with [tenant admin](../../../tenant-settings/tenant-settings.md) access.

- Three [IAM roles](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html) must be created for
  Palette. This includes Palette itself and two of its services. The following table lists the IAM roles that must be
  created.

  | Service                  | IAM Role Name Example      |
  | ------------------------ | -------------------------- |
  | Palette                  | `SpectroCloudRole`         |
  | Palette Hubble service   | `SpectroCloudHubbleRole`   |
  | Palette identity service | `SpectroCloudIdentityRole` |

  - The following trust policy must be assigned to all of the IAM roles created for Palette and the two services. This
    trust policy is the same as outlined in the
    [Amazon EKS documentation](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-association.html#pod-id-association-create).

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowEksAuthToAssumeRoleForPodIdentity",
          "Effect": "Allow",
          "Principal": {
            "Service": "pods.eks.amazonaws.com"
          },
          "Action": ["sts:AssumeRole", "sts:TagSession"]
        }
      ]
    }
    ```

  - The [required IAM policies](required-iam-policies.md) must be assigned to the IAM role created for Palette (for
    example, `SpectroCloudRole`).

  - The following policies must be assigned to the IAM role created for the Palette Hubble service (for example,
    `SpectroCloudHubbleRole`).

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowIAMValidation",
          "Effect": "Allow",
          "Action": [
            "iam:GetRole",
            "iam:ListAttachedRolePolicies",
            "iam:ListRolePolicies",
            "iam:GetRolePolicy",
            "iam:GetPolicy",
            "iam:GetPolicyVersion"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowEC2Describe",
          "Effect": "Allow",
          "Action": [
            "ec2:DescribeRegions",
            "ec2:DescribeAvailabilityZones",
            "ec2:DescribeVpcs",
            "ec2:DescribeSubnets",
            "ec2:DescribeRouteTables",
            "ec2:DescribeKeyPairs"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowEKSDescribe",
          "Effect": "Allow",
          "Action": [
            "eks:DescribeCluster",
            "eks:ListClusters",
            "eks:DescribeNodegroup",
            "eks:ListNodegroups",
            "eks:DescribeAddon",
            "eks:ListAddons"
          ],
          "Resource": "*"
        },
        {
          "Sid": "AllowKMSRead",
          "Effect": "Allow",
          "Action": [
            "kms:ListKeys",
            "kms:ListAliases",
            "kms:DescribeKey",
            "kms:GetKeyPolicy",
            "kms:GetKeyRotationStatus"
          ],
          "Resource": "*"
        }
      ]
    }
    ```

  - The following policies must be assigned to the IAM role created for the Palette identity service (for example,
    `SpectroCloudIdentityRole`).

    - Replace `<role-name-for-palette-iam-role>` with the name of the IAM role created for Palette (for example,
      `SpectroCloudRole`).

    <br />

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "EKS Pod Identity Management",
          "Effect": "Allow",
          "Action": [
            "eks:ListPodIdentityAssociations",
            "eks:CreatePodIdentityAssociation",
            "eks:DeletePodIdentityAssociation"
          ],
          "Resource": ["arn:aws:eks:*:*:cluster/*"]
        },
        {
          "Sid": "IAM PassRole for Pod Identity",
          "Effect": "Allow",
          "Action": ["iam:PassRole"],
          "Resource": ["arn:aws:iam::*:role/<role-name-for-palette-iam-role>"],
          "Condition": {
            "StringLike": {
              "iam:PassedToService": "eks.amazonaws.com"
            }
          }
        }
      ]
    }
    ```

- The IAM roles created for the Palette Hubble service and Palette identity service must have pod identity associations
  with the following Kubernetes service accounts.

  | **Palette Service** | **Kubernetes Namespace** | **Kubernetes Service Account** |
  | ------------------- | ------------------------ | ------------------------------ |
  | Hubble              | `hubble-system`          | `spectro-hubble`               |
  | Identity service    | `palette-identity`       | `palette-identity`             |

  <details>

  <summary> Click to display example AWS CLI commands to create pod identity associations </summary>

  Use the following AWS CLI command to create a pod identity association for the Palette Hubble service. Replace
  `<eks-cluster-name>` with the name of your Amazon EKS cluster, `<aws-account-id>` with your AWS account ID, and
  `<hubble-service-iam-role>` with the name of the IAM role created for the Palette Hubble service (for example,
  `SpectroCloudHubbleRole`).

  ```bash
  aws eks create-pod-identity-association \
  --cluster-name <eks-cluster-name> \
  --namespace hubble-system \
  --service-account spectro-hubble \
  --role-arn arn:aws:iam::<aws-account-id>:role/<hubble-service-iam-role>
  ```

  Similarly, use the following AWS CLI command to create a pod identity association for the Palette identity service.
  Replace `<eks-cluster-name>` with the name of your Amazon EKS cluster, `<aws-account-id>` with your AWS account ID,
  and `<identity-service-iam-role>` with the name of the IAM role created for the Palette identity service (for example,
  `SpectroCloudIdentityRole`).

  ```bash
  aws eks create-pod-identity-association \
  --cluster-name <eks-cluster-name> \
  --namespace palette-identity \
  --service-account palette-identity \
  --role-arn arn:aws:iam::<aws-account-id>:role/<identity-service-iam-role>
  ```

  </details>

- (Optional) If you need your Kubernetes clusters to access AWS resources in different AWS accounts to the one where
  Palette is deployed, you must configure role chaining for EKS Pod Identity. For more information, refer to the
  [Access AWS Resources using EKS Pod Identity Target IAM Roles](https://docs.aws.amazon.com/eks/latest/userguide/pod-id-assign-target-role.html)
  guide.